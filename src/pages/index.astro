---
import BaseLayout from "../layouts/BaseLayout.astro";
import { fetchHomepage } from "../sanity/queries/homepage";

import PortableText from "../components/shared/PortableText.astro";
import Banner from '../components/Banner.astro';
import LatestNews from "../components/homepage/LatestNews.astro";
import NextEvent from "../components/homepage/NextEvent.astro";

import { buildTitle } from "../utils/meta";
import Seo from "../components/shared/Seo.astro";
import HeroOverlaySection from "../components/homepage/HeroOverlaySection.astro";
import { imageBuilder } from "../sanity/lib/url-for-image";
import { fetchGlobals } from "../utils/sanity";

const title = buildTitle("Home");

// Fetch homepage data at build time
const vm = await fetchHomepage();

const globals = await fetchGlobals();

const firstImage = vm?.carouselImages?.[0]; // pass full image object, not just .asset

const preloadImage = firstImage && {
  url: imageBuilder.image(firstImage).width(1200).format("webp").url(),
  srcSet: `
    ${imageBuilder.image(firstImage).width(400).url()} 400w,
    ${imageBuilder.image(firstImage).width(800).url()} 800w,
    ${imageBuilder.image(firstImage).width(1200).url()} 1200w
  `,
  sizes: "100vw",
  type: "image/webp"
};

---

<Seo
  title={title}
  description={globals?.description}
  preloadImage={preloadImage}
/>

<BaseLayout>
  <Banner />
  <HeroOverlaySection images={vm?.carouselImages} />
  <div class="container-over-hero">
    <div class="content">
      <div class="primary">
        {vm?.whoWeAre && (
          <section id="who-we-are" class="portable-text">
            <div class="panel-content">
              <h2>Who We Are</h2>
              <PortableText portableText={vm.whoWeAre} />
            </div>
          </section>
        )}
        <aside>
          <NextEvent />
          <LatestNews />
        </aside>
      </div>
      <div class="secondary">
        {vm?.whatWeDo && (
          <section id="what-we-do" class="portable-text">
            <div class="panel-content">
              <h2>What We Do</h2>
              <PortableText portableText={vm.whatWeDo} />
            </div>
          </section>
        )}
        {vm?.whenWeMeet && (
          <section id="when-we-meet" class="portable-text">
            <div class="panel-content">
              <h2>When We Meet</h2>
              <PortableText portableText={vm.whenWeMeet} />
            </div>
          </section>
        )}
        {vm?.whereWeMeet && (
          <section id="where-we-meet" class="portable-text">
            <div class="panel-content">
              <h2>Where We Meet</h2>
              <PortableText portableText={vm.whereWeMeet} />
            </div>
          </section>
        )}
      </div>
    </div>
  </div>
</BaseLayout>

<style scoped lang="scss">
  @use "../styles/_breakpoints.scss" as *;
  @use "../styles/_panel.scss" as *;

  .container-over-hero {
    position: relative;
    margin-top: -100px;
  }

  .content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin: 1rem;

    .primary {
      display: flex;
      flex-direction: column-reverse;
      gap: 1rem;
    }
    .secondary {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
  }

  section {
    @include panel;
  }
  aside {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .panel-content {
    @include panel-border;
    height: 100%;
  }

  @media (min-width: $BREAKPOINT_SMALL) {
    aside {
      flex-direction: row;
    }
  }

  @media (min-width: $BREAKPOINT_TABLET_PORTRAIT) {
    section {
      flex: 1;
      max-width: 100%;
    }
    .secondary {
      flex-direction: row;
    }
  }

  @media (min-width: $BREAKPOINT_HOMEPAGE_DESKTOP_LAYOUT) {
    .primary {
      flex-direction: row;
      section {
        flex: 2;
      }
      aside {
        flex-direction: column;
        flex: 1;
      }
    }
  }
</style>
