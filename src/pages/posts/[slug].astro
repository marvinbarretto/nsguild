---
import BaseLayout from "../../layouts/BaseLayout.astro";
import PortableText from "../../components/PortableText.astro";
import LightboxGallery from "../../components/LightboxGallery.astro";
import type { Post } from "../../utils/types";
import { fetchAllPosts, transformImagesToGalleryFormat } from "../../utils/sanity";

// Prerender static HTML at build time, good to do when poss
export const prerender = true;

// Fetch all slugs and corresponding post data
export async function getStaticPaths() {
  const posts = await fetchAllPosts();

  // Return an array of slugs and post props
  return posts.map((post: any) => ({
    params: {slug: post.slug.current},
    props: {post},
  }))
}

// Astro provides 'post' via props from getStaticPaths
const { post }: { post: Post } = Astro.props;

const galleryImages = post.images ? transformImagesToGalleryFormat(post.images) : [];

const formattedDate = new Date(post.publishedAt).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Debug output
console.log("Post Data:", JSON.stringify({
  title: post.title,
  publishedAt: post.publishedAt,
  attachPublication: post.attachPublication,
  attachedPublication: post.attachedPublication
}, null, 2));

// Debugging Output
// console.log("Post Object:", post);
// console.log("Gallery Images:", galleryImages);

---

<BaseLayout>
  <article>
    <div class="post-header">
      <h1>{post.title}</h1>
      <p>Published on {formattedDate}</p>
      {post.attachPublication && post.attachedPublication && (
        <a 
          href={post.attachedPublication.documentUrl}
          target="_blank"
          rel="noopener noreferrer"
        >
          <span class="text-xl">ðŸ“„</span>
          <span>{post.attachedPublication.title}</span>
        </a>
      )}
    </div>
    <div class="post-body test">
      <PortableText value={post.body} />
    </div>
    {galleryImages.length > 0 ? (
      <div class="post-images">
        <LightboxGallery images={galleryImages} style="default" />
      </div>
    ) : null}
  </article> 
</BaseLayout>

<style lang="scss">
  @import "../../styles/jagged-edge";

  h1 {
    font-size: 2rem;
    font-weight: bold;
  }
  
  .post-header {
    background-color: white;
  }

  .test {
    position: relative;
    padding: 1rem;
    margin: 1rem;
    background-color: red;
  }

  .test::before {
    content: '';
    position: absolute;
    top: -5px;
    left: -5px;
    right: -5px;
    bottom: -5px;
    background-color: red;
    z-index: -1;
    @include jagged-border(5px, 1%); // 
  }

  .test > * {
    position: relative;
    z-index: 1;
  }

  .post-images {
    background-color: #CCC;
    margin-top: 1rem;
    padding: 1rem;
  }
</style>